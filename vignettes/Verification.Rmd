---
title: "Verification"
author: "Simon Adamov"
date: "September 30, 2020"
output: html_document
---

```{r}
# DEFINE YOUR COSMO-OUTPUT FOLDER HERE

cosmo_path <- paste0(here::here(), "/vignettes/ext-data/cosmo_orig_20200303_24h.csv")

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      error = FALSE, 
                      warning = FALSE, 
                      message = FALSE,
                      fig.retina =3,
                      fig.width = 10,
                      fig.height = 7,
                      out.width = "100%",
                      out.height = "100%")


library(mchdwh)
if (Sys.info()["nodename"] != "tsa-ln002") library(ROracle)
library(dplyr)
library(readr)
library(tidyr)
library(purrr)
library(stringr)
library(scales)
library(psych)
library(caret)
library(lubridate)
library(padr)
library(tsibble)
library(feasts)
library(fabletools)
library(kableExtra)
library(ggpubr)
# These themes just look great :-)
library(ggthemr)
# devtools::install_github('cttobin/ggthemr')
ggthemr("fresh")

devtools::load_all(".")

library(conflicted)
conflict_prefer(name = "select", winner = "dplyr")
conflict_prefer(name = "filter", winner = "dplyr")
conflict_prefer(name = "lag", winner = "dplyr")
conflict_prefer(name = "rescale", winner = "scales")

# remotes::install_version("caTools", version = "1.17.1.1")
# This library is needed for visual representation of missing data
# library(Amelia)
# remotes::install_version("foreign", version = "0.8-71")
# install.packages("Amelia")


```

This vignette can be used "operationally" in the pollen model verification pipeline. The intent is to compare one or multiple timeseries of pollen concentrations predicted by different COMOS-devbuild with the measurements from the DWH. Based on various studies about the reliability of Hirst trap measurements daily averages are used. (Well to start with we use hourly, as we don't model full days).

```{r}
load(paste0(here::here(), "/vignettes/ext-data/data_aggs.RData"))
```

# Data Import


The data is obtained from the DWH for the current pollen season (2020). 
The Model Data from COSMO-ART is available on tsa (CSCS) in /store.

```{r }

# The following types are being measured:
# Erle - Alder - Aulne - Alnus
# Birke - Birch - Bouleau - Betula
# Gräser - Grasses - Graminées - Poaceae
# Ambrosia - Ragweed - Ambroisie - Ambrosia

species_all <- tibble(
  taxon = c(
    "Castanea",
    "Alnus",
    "Ulmus",
    "Cupressus",
    "Fraxinus",
    "Fagus",
    "Juglans",
    "Plantago",
    "Corylus",
    "Pinus",
    "Quercus",
    "Rumex",
    "Platanus",
    "Populus",
    "Poaceae",
    "Salix",
    "Betula",
    "Carpinus",
    "Urtica",
    "Taxus",
    "Picea",
    "Ambrosia"
  ),
  hirst_taxon = c(
    "kacastz0",
    "kaalnuz0",
    "kaulmuz0",
    "kacuprz0",
    "kafraxz0",
    "kafaguz0",
    "kajuglz0",
    "khplanz0",
    "kacoryz0",
    "kapinuz0",
    "kaquerz0",
    "khrumez0",
    "kaplatz0",
    "kapopuz0",
    "khpoacz0",
    "kasaliz0",
    "kabetuz0",
    "kacarpz0",
    "khurtiz0",
    "kataxuz0",
    "kapicez0",
    "khambrz0"
  ),
  cosmo_taxon = c(
    NA_character_,
    "ALNU",
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    "POAC",
    NA_character_,
    "BETU",
    NA_character_,
    NA_character_,
    NA_character_,
    NA_character_,
    "AMBR"
  )
)

species <- species_all %>%
  filter(taxon %in% c("Alnus", "Ambrosia", "Betula", "Poaceae"))

stations <-
  tibble(
    hirst_station = c(
      "PDS",
      "PBU",
      "PMU",
      "PBS",
      "PZH",
      "PLZ",
      "PBE",
      # "PPY",
      "PNE",
      "PVI",
      "PLS",
      "PGE",
      "PCF",
      "PLO",
      # "BLR",
      "PLU"
    ),
    station = c(
      "Wolfgang",
      "Buchs",
      "Münsterlingen",
      "Basel",
      "Zürich",
      "Luzern",
      "Bern",
      # "Payerne",
      "Neuchâtel",
      "Visp",
      "Lausanne",
      "Genève",
      "La-Chaux-de-Fonds",
      "Locarno",
      # "Balerna",
      "Lugano"
      ),
    cosmo_station = c(
      "CHDAVO",
      "CHBUCH",
      "CHMUEN",
      "CHBASE",
      "CHZUER",
      "CHLUZE",
      "CHBERN",
      # NA_character_,
      "CHNEUC",
      "CHVISP",
      "CHLAUS",
      "CHGENE",
      "CHLACH",
      "CHLOCA",
      # NA_character_,
      "CHLUGA"
    )
  )

```

```{r}
data_cosmo <- read_table2(cosmo_path, skip = 17, col_names = TRUE) %>%
  mutate_at(vars(CHBASE:CHZUER), ~ ifelse(. < 0, NA_real_, .)) %>% # setting na during import failed for some reason
  pivot_longer(CHBASE:CHZUER, names_to = "station_tag", values_to = "value") %>%
  mutate(measurement = case_when(str_detect(PARAMETER, pattern = "sdes") ~ "phenology",
                                 str_detect(PARAMETER, pattern = "fe") ~ "emission",
                                 TRUE ~ "concentration"),
         PARAMETER = str_replace_all(PARAMETER, "sdes|fe", "")) %>%
  inner_join(species, by = c("PARAMETER" = "cosmo_taxon")) %>%
  inner_join(stations, by = c("station_tag" = "cosmo_station")) %>%
  mutate(datetime = ymd_h(paste0(YYYY, sprintf("%02d", MM), sprintf("%02d", DD), sprintf("%02d", hh))),
         date = date(datetime),
         hour = hour(datetime),
         type = "Cosmo") %>%
  # filter(between(datetime, as_datetime("2017-03-02 00:01:00"), as_datetime("2020-08-19 00:00:00"))) %>%
  select(taxon, station, date, hour, value, datetime, type, measurement)

```

```{r}
data_daily_cosmo <- data_cosmo %>% 
  group_by(taxon, station, date, type, measurement) %>% 
  summarise(value = mean(value, na.rm = TRUE)) %>% # Currently the values are not averaged per hour but simply retrieved at every hour.
  ungroup %>% 
  mutate(hour = 0,
         # date = date + days(1), # Depends on the definition
         datetime = ymd_hm(paste0(as.character(date), paste0(sprintf("%02d", hour), ":00"))))
```

# Missing Data and Imputation

There are no NAs in the original data. But there are some timestamps where no data was retrieved.
We will work with daily average concentrations below and hence have averaged values per hour and then per day.
Generally, missing data usually occurs when the silicone rubber bands were being exchanged.

## Padding

```{r}

data_hourly_imp <- data$data_hourly %>%
  filter(between(datetime, min(data_cosmo$datetime), max(data_cosmo$datetime))) %>%
  pad(
    start_val =  min(data_cosmo$datetime),
    end_val = max(data_cosmo$datetime),
    group = c("station", "taxon"),
    by = "datetime",
    break_above = 2
  ) %>% 
  mutate(
    date = date(datetime),
    hour = hour(datetime),
    type = "Hirst",
    measurement = "concentration",
    value = if_else(is.na(value), 0, value)
  )

data_daily_imp <- data$data_daily %>%
  filter(between(datetime, min(data_cosmo$date), max(data_cosmo$date))) %>%
  pad(
    start_val =  min(data_cosmo$date),
    end_val = max(data_cosmo$date),
    group = c("station", "taxon"),
    by = "datetime",
    break_above = 2
  ) %>% 
  mutate(
    date = date(datetime),
    hour = hour(datetime),
    type = "Hirst",
    measurement = "concentration",
    value = if_else(is.na(value), 0, value)
  )

data_hourly_cosmo_imp <- data_cosmo %>% 
  filter(between(datetime, min(data_cosmo$datetime), max(data_cosmo$datetime)),
         measurement == "concentration") %>%
  pad(
    start_val =  min(data_cosmo$datetime),
    end_val = max(data_cosmo$datetime),
    group = c("station", "taxon"),
    by = "datetime",
    break_above = 2
  ) %>% 
  mutate(
    date = date(datetime),
    hour = hour(datetime),
    type = "Cosmo",
    measurement = "concentration",
    value = if_else(is.na(value), 0, value)
  )
  
data_daily_cosmo_imp <- data_daily_cosmo %>%
  filter(measurement == "concentration") %>% 
  pad(
    start_val =  min(data_cosmo$date),
    end_val = max(data_cosmo$date),
    group = c("station", "taxon", "measurement"),
    by = "datetime",
    break_above = 2
  ) %>% 
  mutate(
    date = date(datetime),
    hour = hour(datetime),
    type = "Cosmo",
    value = if_else(is.na(value), 0, value)
  )
  
data_daily_comb <- data_daily_imp %>%
  bind_rows(data_daily_cosmo_imp)

data_hourly_comb <- data_hourly_imp %>% 
  bind_rows(data_hourly_cosmo_imp)

data_hourly_comb %>% 
  filter(type == "Hirst",
         taxon == "Alnus")

```


```{r}
plot_comb(taxon = "Alnus", station = stations$station, resolution = "Daily", combined = TRUE, rm_zeros = FALSE)
```


```{r }

occurence <- data_daily_comb %>% 
  group_by(taxon, station, type) %>% 
  summarise(value = sum(value != 0)) %>% 
  ungroup() %>% 
  mutate(metric = "occurence")

maximum <- data_daily_comb %>% 
  group_by(taxon, station, type) %>% 
  summarise(value = max(value)) %>% 
  ungroup() %>% 
  mutate(metric = "maximum")

average <- data_daily_comb %>% # This would need a season definition
  group_by(taxon, station, type) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  mutate(metric = "average")

spi <- data_daily_comb %>% 
  group_by(taxon, station, type) %>% 
  summarise(value = sum(value)) %>% 
  ungroup() %>% 
  mutate(metric = "spi")

# metrics <- bind_rows(occurence, maximum, average, spi)

create_kable(occurence, title = "Occurence of Pollen [Days]")
create_kable(maximum, title = "Maximum Pollen Concentration [m⁻³]")
create_kable(average, title = "Average Pollen Concentration [m⁻³]")
create_kable(spi, title = "Seasonal Pollen Integral [days*m⁻³]")

```


```{r fig.height=6, fig.width=9}

# stations_selected <- "Zürich" # Check stations tibble for all available locations
taxa_selected <- c("Alnus", "Betula", "Poaceae", "Ambrosia") # Check species tibble for all available pollen taxa
gg_timeseries <- list()

for (s in stations$station %>% sort){
  data_timeseries <- data_hourly_comb %>% 
    filter(taxon %in% taxa_selected,
           station %in% s)
  
  large_diffs <- data_timeseries %>%
    pivot_wider(names_from = type) %>% 
    mutate(diff = Hirst - Cosmo,
           mean_pol = (Hirst + Cosmo) / 2,
           large_diff = if_else(Hirst > 20 & ((abs(diff) + mean_pol) / mean_pol > 2), date, as.Date(NA))) %>% 
    pull(large_diff) %>% 
    unique()
  
  gg_timeseries[[s]] <- data_timeseries %>% 
    ggplot(aes(x = datetime, y = value, col = taxon, lty = type)) +
      geom_line(alpha = 0.6) +
      geom_vline(xintercept = large_diffs, alpha = 0.1, col = swatch()[1], size = 1) +
      ggtitle(paste("Hourly", paste(taxa_selected, collapse = ", "), "Pollen Concentrations in", s)) +
    labs(y = expression(paste("Pollen Concentration [", m^-3, "]")),
         x = "2020 Season") +
    scale_colour_discrete("Species") +
    scale_linetype_discrete("Data")
}

gg_timeseries

# data_daily_comb %>% filter(taxon == "Betula", type == "Hirst", station == "Luzern") # There is missing data in Luzern for Betula.

```


